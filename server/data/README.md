# Система коэффициентов

## Как использовать

### 1. Добавление ваших данных

Замените содержимое файла `coefficients.json` на ваш полный JSON файл с 13000 строк.

### 2. Структура данных

JSON должен иметь следующую структуру:

```json
{
  "products": {
    "system_key": {
      "categories": {
        "category_name": {
          "widths": [0.1, 0.2, 0.3, ...],
          "heights": [0.1, 0.2, 0.3, ...],
          "values": [
            [val1, val2, val3, ...],
            [val4, val5, val6, ...],
            ...
          ]
        }
      }
    }
  }
}
```

**Где:**

- `system_key` - уникальный ключ системы (например, "uni1_zebra", "uni2_roller", и т.д.)
- `category_name` - категория ткани (например, "E", "1", "2", "3", "4", "5")
- `widths` - массив значений ширины в метрах (по возрастанию)
- `heights` - массив значений высоты в метрах (по возрастанию)
- `values` - двумерный массив коэффициентов [высота][ширина]

### 3. Настройка систем в БД

В таблице `systems` добавьте поле `system_key`, которое должно соответствовать ключам в JSON файле.

Например:

- Имя системы: "Uni1 Zebra Classic"
- System Key: "uni1_zebra"

### 4. API Endpoints

#### Получить коэффициент

```
POST /api/coefficients/calculate
{
  "systemKey": "uni1_zebra",
  "category": "E",
  "width": 1.5,
  "height": 2.0
}
```

**Ответ:**

```json
{
  "coefficient": 14.2684,
  "systemKey": "uni1_zebra",
  "category": "E",
  "width": 1.5,
  "height": 2.0
}
```

#### Получить список систем

```
GET /api/coefficients/systems
```

**Ответ:**

```json
{
  "systems": ["uni1_zebra", "uni2_roller", ...]
}
```

#### Получить категории для системы

```
GET /api/coefficients/systems/:systemKey/categories
```

**Ответ:**

```json
{
  "systemKey": "uni1_zebra",
  "categories": ["E", "1", "2", "3", "4", "5"]
}
```

#### Получить диапазоны размеров

```
GET /api/coefficients/ranges?systemKey=uni1_zebra&category=E
```

**Ответ:**

```json
{
  "systemKey": "uni1_zebra",
  "category": "E",
  "widthRange": { "min": 0.1, "max": 3.0 },
  "heightRange": { "min": 0.1, "max": 3.0 }
}
```

## Как работает интерполяция

Система использует **билинейную интерполяцию** для нахождения коэффициентов между узлами сетки.

Если запрашиваемые ширина/высота не совпадают с точками в массиве, коэффициент рассчитывается автоматически на основе ближайших 4 точек.

### Пример:

Если в данных есть:

- Ширины: [1.0, 1.5, 2.0]
- Высоты: [1.5, 2.0, 2.5]

А вы запрашиваете width=1.3, height=1.8, система найдет коэффициент между точками (1.0,1.5), (1.5,1.5), (1.0,2.0), (1.5,2.0) используя интерполяцию.

## Использование в формулах

Пример использования в формуле заказа:

```typescript
const coefficient = await getCoefficient(
  system.systemKey,
  fabric.category,
  order.width / 1000, // перевод мм в метры
  order.height / 1000
);

const price = coefficient * multiplier + additionalCosts;
```

## Производительность

- JSON файл загружается один раз при первом запросе
- Данные кэшируются в памяти
- Поиск и интерполяция выполняются быстро (< 1мс)
- Подходит для работы с большими объемами данных (13000+ строк)


