name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è forsa –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π
            su - forsa << 'EOF'
            cd forsa-crm-zhalusi

            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ node 22
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 22

            # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ä—Ç–µ 5000
            npx kill-port 5000 || true

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º .env –µ—Å–ª–∏ –µ—Å—Ç—å
            if [ -f .env ]; then
              cp .env /tmp/.env.backup
              echo "‚úÖ .env saved"
            fi

            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∫–æ–¥
            git fetch origin
            git reset --hard origin/main

            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env
            if [ -f /tmp/.env.backup ]; then
              cp /tmp/.env.backup .env
              echo "‚úÖ .env restored"
            fi

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            npm install

            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            echo "üîÑ Applying database migrations..."
            npm run db:migrate || {
              echo "‚ùå Migration failed, showing error:"
              exit 1
            }
            echo "‚úÖ Migrations applied successfully"

            # –î–µ–ª–∞–µ–º —Å–±–æ—Ä–∫—É
            npm run build

            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            nohup npm run start > app.log 2>&1 &

            # –ñ–¥–µ–º —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å
            sleep 5

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "=== Checking server status ==="
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/user 2>/dev/null | grep -q "200\|401"; then
              echo "‚úÖ Server is responding"
            else
              echo "‚ö†Ô∏è Server may have issues, showing logs:"
              tail -50 app.log
            fi
            EOF

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx
            systemctl restart nginx
